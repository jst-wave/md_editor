# Google Docs連携機能 要件定義書

## 1. プロジェクト概要

### 1.1 目的
ブラウザ上のMarkdownメモアプリケーションから、ワンクリックでGoogle Docsにコンテンツをアップロードできる機能を提供する。

### 1.2 対象ユーザー
- Markdownでメモを作成するユーザー
- Google Docsを日常的に使用するユーザー
- ブラウザベースのエディタを使用するユーザー

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 Google Docs アップロード機能
- **機能ID**: F001
- **概要**: メモアプリのコンテンツをGoogle Docsドキュメントとしてアップロード
- **詳細**:
  - エディタ内のMarkdownテキストを取得
  - ユーザーが選択可能な形式でアップロード（Markdown/HTML）
  - Google Docs APIを使用してドキュメントを作成
  - 作成されたドキュメントのURLを提供

#### 2.1.2 Google OAuth認証機能
- **機能ID**: F002
- **概要**: Google アカウントによる認証とアクセス権限の取得
- **詳細**:
  - OAuth 2.0 フローを使用した認証
  - Google Docs APIへのアクセス権限取得
  - 認証状態の永続化（明示的なログアウトまで保持）

### 2.2 ユーザーインターフェース

#### 2.2.1 アップロードボタン
- **配置**: メインツールバー内
- **表示状態**:
  - 未認証時: "Google Docs (ログイン)" 
  - 認証済み時: "Google Docs (ユーザー名)"
- **動作**:
  - 未認証時: OAuth認証フローを開始
  - 認証済み時: アップロード処理を実行

#### 2.2.2 認証フロー画面
- **表示方式**: ポップアップウィンドウ
- **内容**:
  - Google ログイン画面
  - 権限許可画面
  - 認証完了通知

#### 2.2.3 アップロード設定画面
- **表示要素**:
  - ドキュメントタイトル表示（現在のタブタイトルを自動設定）
  - アップロード形式選択（Markdown/HTML）
  - アップロード実行ボタン
  - キャンセルボタン

#### 2.2.4 アップロード進行状況
- **表示要素**:
  - ボタンテキストの変更: "⏳ アップロード中..."
  - ボタンの無効化
  - 進行状況の視覚的フィードバック

#### 2.2.5 エラー表示・リトライ機能
- **表示要素**:
  - 詳細なエラーメッセージ
  - エラー分類別の対処法案内
  - リトライボタン
  - サポート情報へのリンク

## 3. 非機能要件

### 3.1 セキュリティ要件
- OAuth 2.0 標準に準拠した認証
- アクセストークンの安全な保存
- HTTPS通信の使用（本番環境）
- 認証情報の適切な期限管理

### 3.2 パフォーマンス要件
- アップロード処理の完了時間: 10秒以内
- 認証フローの完了時間: 30秒以内
- UI応答性: 1秒以内

### 3.3 互換性要件
- **ブラウザサポート**:
  - Chrome (最新版)
  - Firefox (最新版)
  - Edge (最新版)
  - Safari (最新版)
- **Google API互換性**: Google Docs API v1

## 4. 技術仕様

### 4.1 アーキテクチャ
```
[フロントエンド] ←→ [認証サーバー] ←→ [Google API]
     ↓
[ローカルストレージ]
```

### 4.2 技術スタック
- **フロントエンド**: JavaScript (ES6+), HTML5, CSS3
- **認証サーバー**: Node.js, Express.js
- **外部API**: Google Docs API, Google OAuth 2.0 API
- **データ保存**: localStorage (認証情報)

### 4.3 API仕様

#### 4.3.1 使用するGoogle API
- **Google OAuth 2.0 API**: 認証とアクセストークン取得
- **Google Docs API**: ドキュメント作成とコンテンツ挿入
- **Google Drive API**: 作成されたドキュメントへのアクセス

#### 4.3.2 必要な権限スコープ
- `https://www.googleapis.com/auth/documents`: Docsドキュメントの作成・編集
- `https://www.googleapis.com/auth/drive.file`: 作成したファイルへのアクセス

## 5. ユーザーフロー

### 5.1 初回利用フロー
1. ユーザーがGoogle Docsボタンをクリック
2. アップロード設定画面が表示
   - タブタイトルが自動設定される
   - アップロード形式を選択（Markdown/HTML）
3. OAuth認証ポップアップが表示
4. Googleアカウントでログイン
5. アプリケーションへの権限許可
6. 認証完了後、ポップアップが閉じる
7. メインアプリでアップロード処理実行
8. 成功通知とドキュメントURLの提示

### 5.2 再利用フロー（認証済み）
1. ユーザーがGoogle Docsボタンをクリック
2. アップロード設定画面が表示
   - タブタイトルが自動設定される
   - アップロード形式を選択（Markdown/HTML）
3. 即座にアップロード処理開始
4. 成功通知とドキュメントURLの提示

### 5.3 エラー処理フロー
- **認証失敗**: 詳細なエラーメッセージ表示、再認証オプション提供
- **ネットワークエラー**: エラー詳細とリトライボタン表示
- **API制限エラー**: 制限内容と待機時間の詳細案内、自動リトライオプション
- **コンテンツエラー**: サイズ制限やフォーマットエラーの詳細説明

## 6. データ仕様

### 6.1 アップロードデータ
- **形式**: 
  - プレーンテキスト（Markdown）- ユーザー選択時
  - HTML（Markdownから変換）- ユーザー選択時
- **文字エンコーディング**: UTF-8
- **最大サイズ**: Google Docs制限に準拠

### 6.2 ドキュメントメタデータ
- **タイトル**: 現在のタブタイトルを使用
- **作成日時**: アップロード実行時刻
- **形式**: Google Docsドキュメント
- **アップロード形式**: ユーザー選択に基づく（Markdown/HTML）

### 6.3 認証データ（ローカル保存）
```json
{
  "accessToken": "string",
  "refreshToken": "string",
  "userInfo": {
    "email": "string",
    "name": "string"
  },
  "timestamp": "number",
  "expiresAt": "number"
}
```

### 6.4 アップロード設定データ
```json
{
  "uploadFormat": "markdown|html",
  "documentTitle": "string",
  "lastUsedFormat": "markdown|html"
}
```

## 7. エラーハンドリング

### 7.1 認証関連エラー
| エラーコード | 内容 | 詳細表示 | 対応 |
|-------------|------|----------|------|
| AUTH_FAILED | 認証失敗 | Googleアカウントの認証に失敗しました | 再認証ボタン、アカウント確認手順 |
| TOKEN_EXPIRED | トークン期限切れ | アクセストークンの有効期限が切れました | 自動再認証、手動再認証オプション |
| PERMISSION_DENIED | 権限不足 | 必要な権限が許可されていません | 必要権限の説明と再認証ボタン |
| NETWORK_AUTH_ERROR | 認証通信エラー | 認証サーバーとの通信に失敗しました | リトライボタン、ネットワーク確認手順 |

### 7.2 アップロード関連エラー
| エラーコード | 内容 | 詳細表示 | 対応 |
|-------------|------|----------|------|
| UPLOAD_FAILED | アップロード失敗 | Google Docsへのアップロードに失敗しました | リトライボタン、エラー詳細表示 |
| CONTENT_TOO_LARGE | コンテンツサイズ超過 | ファイルサイズが制限を超えています（制限: XXX文字） | コンテンツ縮小の提案 |
| API_QUOTA_EXCEEDED | API制限超過 | Google APIの利用制限に達しました | 待機時間表示、自動リトライ設定 |
| FORMAT_CONVERSION_ERROR | 形式変換エラー | Markdown→HTML変換に失敗しました | Markdown形式での再試行オプション |
| NETWORK_UPLOAD_ERROR | アップロード通信エラー | Google APIとの通信に失敗しました | リトライボタン、接続状況確認 |

### 7.3 リトライ機能仕様
- **自動リトライ**: ネットワークエラー時に3回まで自動実行
- **手動リトライ**: すべてのエラーでリトライボタンを表示
- **待機時間表示**: API制限時に残り時間をカウントダウン表示
- **エラー履歴**: 過去のエラー情報を保持（デバッグ支援）

## 8. テスト要件

### 8.1 機能テスト
- OAuth認証フローの正常動作
- アップロード処理の正常動作
- エラー処理の動作確認
- UI/UXの操作性確認

### 8.2 セキュリティテスト
- 認証情報の適切な保護
- 不正アクセスの防止
- トークンの適切な管理

### 8.3 パフォーマンステスト
- 大容量コンテンツのアップロード
- 同時アクセス時の動作
- ネットワーク遅延時の動作

## 9. 運用要件

### 9.1 設定管理
- Google Cloud Console でのOAuth設定
- 環境変数での認証情報管理
- 本番/開発環境の分離

### 9.2 監視・ログ
- アップロード成功/失敗の統計
- 認証エラーの監視
- パフォーマンスメトリクス

## 10. 制約事項

### 10.1 技術的制約
- Google API の利用制限（クォータ）
- ブラウザのCORS制限
- localStorage容量制限

### 10.2 機能制約
- アップロード形式はプレーンテキストのみ
- Markdownの装飾は反映されない
- 画像などのメディアファイルは非対応

## 11. 今後の拡張可能性

### 11.1 短期的拡張
- Markdown → HTML変換でのアップロード
- ドキュメントタイトルのカスタマイズ
- アップロード履歴の表示

### 11.2 長期的拡張
- Google Drive フォルダ指定
- Google Sheets への出力
- 他のクラウドサービス連携

---

**文書作成日**: 2025年6月9日  
**文書バージョン**: 1.0  
**作成者**: システム要件定義  
**承認者**: [承認者名]
