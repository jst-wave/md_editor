/**
 * Google Docs OAuth Upload Functionality
 * Ë¶Å‰ª∂ÂÆöÁæ©„Å´Âü∫„Å•„ÅèÂÆåÂÖ®ÁâàÂÆüË£Ö
 */

class GoogleDocsUploader {
    constructor() {
        this.isAuthenticated = false;
        this.accessToken = null;
        this.userInfo = null;
        this.authServerUrl = 'http://localhost:3001';
        this.retryCount = 0;
        this.maxRetries = 3;
        
        console.log('GoogleDocsUploader ÂàùÊúüÂåñÂÆå‰∫Ü');
        
        // Ë™çË®ºÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
        this.restoreAuthState();
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        this.setupEventListeners();
        
        // UIË¶ÅÁ¥†„ÇíÂàùÊúüÂåñ
        this.initializeUI();
    }

    // Ë™çË®ºÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
    restoreAuthState() {
        try {
            const authData = localStorage.getItem('google_auth_data');
            if (authData) {
                const data = JSON.parse(authData);
                
                // ÊúâÂäπÊúüÈôê„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (data.expiresAt && data.expiresAt > Date.now()) {
                    this.accessToken = data.accessToken;
                    this.userInfo = data.userInfo;
                    this.isAuthenticated = true;
                    console.log('Ë™çË®ºÁä∂ÊÖã„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü:', this.userInfo?.name);
                } else {
                    console.log('Ë™çË®º„Éà„Éº„ÇØ„É≥„ÅåÊúüÈôêÂàá„Çå„Åß„Åô');
                    this.clearAuthState();
                }
            }
        } catch (error) {
            console.error('Ë™çË®ºÁä∂ÊÖã„ÅÆÂæ©ÂÖÉ„Ç®„É©„Éº:', error);
            this.clearAuthState();
        }
    }

    // UIË¶ÅÁ¥†„ÇíÂàùÊúüÂåñ
    initializeUI() {
        this.updateButtonState();
        this.createUploadModal();
        this.addModalStyles();
    }

    // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    updateButtonState() {
        const button = document.getElementById('google-docs-btn');
        if (!button) return;

        if (this.isAuthenticated && this.userInfo) {
            button.textContent = `Google Docs (${this.userInfo.name})`;
            button.classList.add('authenticated');
        } else {
            button.textContent = 'Google Docs („É≠„Ç∞„Ç§„É≥)';
            button.classList.remove('authenticated');
        }
    }

    // „É¢„Éº„ÉÄ„É´Áî®„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
    addModalStyles() {
        if (document.getElementById('upload-modal-styles')) return;

        const style = document.createElement('style');
        style.id = 'upload-modal-styles';
        style.textContent = `
            .modal {
                display: none;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
            }

            .modal-content {
                background-color: #fefefe;
                margin: 10% auto;
                padding: 0;
                border: none;
                border-radius: 8px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }

            .modal-header {
                background-color: #4285f4;
                color: white;
                padding: 20px;
                border-radius: 8px 8px 0 0;
                position: relative;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 18px;
            }

            .modal-header .close {
                position: absolute;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 24px;
                cursor: pointer;
                user-select: none;
            }

            .modal-body {
                padding: 20px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #333;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                box-sizing: border-box;
            }

            .error-message {
                background-color: #fee;
                color: #c33;
                padding: 10px;
                border-radius: 4px;
                margin-bottom: 15px;
                border-left: 4px solid #c33;
            }

            .retry-section {
                text-align: center;
                padding: 10px;
            }

            .modal-footer {
                padding: 20px;
                text-align: right;
                border-top: 1px solid #eee;
                border-radius: 0 0 8px 8px;
            }

            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-left: 10px;
                transition: background-color 0.2s;
            }

            .btn-primary {
                background-color: #4285f4;
                color: white;
            }

            .btn-primary:hover {
                background-color: #3367d6;
            }

            .btn-secondary {
                background-color: #f8f9fa;
                color: #3c4043;
                border: 1px solid #dadce0;
            }

            .btn-secondary:hover {
                background-color: #e8eaed;
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .progress-bar {
                width: 100%;
                height: 4px;
                background-color: #f0f0f0;
                border-radius: 2px;
                overflow: hidden;
                margin: 10px 0;
            }

            .progress-bar-fill {
                height: 100%;
                background-color: #4285f4;
                width: 0%;
                transition: width 0.3s ease;
            }
        `;
        document.head.appendChild(style);
    }

    // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆö„É¢„Éº„ÉÄ„É´„Çí‰ΩúÊàê
    createUploadModal() {
        if (document.getElementById('upload-modal')) return;

        const modal = document.createElement('div');
        modal.id = 'upload-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Google Docs„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="document-title">„Éâ„Ç≠„É•„É°„É≥„Éà„Çø„Ç§„Éà„É´:</label>
                        <input type="text" id="document-title" value="" placeholder="„Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ">
                    </div>
                    <div class="form-group">
                        <label for="upload-format">„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂΩ¢Âºè:</label>
                        <select id="upload-format">
                            <option value="markdown">MarkdownÔºà„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ</option>
                            <option value="html">HTMLÔºà„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰ªò„ÅçÔºâ</option>
                        </select>
                    </div>
                    <div class="progress-bar" id="upload-progress" style="display: none;">
                        <div class="progress-bar-fill" id="progress-fill"></div>
                    </div>
                    <div class="error-message" id="upload-error" style="display: none;"></div>
                    <div class="retry-section" id="retry-section" style="display: none;">
                        <button id="retry-btn" class="btn btn-secondary">üîÑ „É™„Éà„É©„Ç§</button>
                        <span id="retry-countdown"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="upload-execute-btn" class="btn btn-primary">üì§ „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
                    <button id="upload-cancel-btn" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        this.setupModalEventListeners();
    }

    // „É¢„Éº„ÉÄ„É´„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
    setupModalEventListeners() {
        const modal = document.getElementById('upload-modal');
        const closeBtn = modal.querySelector('.close');
        const cancelBtn = document.getElementById('upload-cancel-btn');
        const executeBtn = document.getElementById('upload-execute-btn');
        const retryBtn = document.getElementById('retry-btn');

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        const closeModal = () => {
            modal.style.display = 'none';
            this.resetModalState();
        };

        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Èñâ„Åò„Çã
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å
        executeBtn.addEventListener('click', () => {
            const title = document.getElementById('document-title').value.trim();
            const format = document.getElementById('upload-format').value;
            
            if (!title) {
                this.showError('„Éâ„Ç≠„É•„É°„É≥„Éà„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            this.executeUpload(title, format);
        });

        // „É™„Éà„É©„Ç§
        retryBtn.addEventListener('click', () => {
            const title = document.getElementById('document-title').value.trim();
            const format = document.getElementById('upload-format').value;
            this.executeUpload(title, format);
        });
    }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
    setupEventListeners() {
        // Google Docs„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        const interval = setInterval(() => {
            const button = document.getElementById('google-docs-btn');
            if (button) {
                button.addEventListener('click', () => this.handleUpload());
                clearInterval(interval);
            }
        }, 100);
    }

    // „É°„Ç§„É≥„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
    async handleUpload() {
        if (!this.isAuthenticated) {
            // Êú™Ë™çË®º„ÅÆÂ†¥Âêà„ÅØË™çË®º„ÇíÈñãÂßã
            await this.startAuthentication();
            return;
        }

        // Ë™çË®ºÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆöÁîªÈù¢„ÇíË°®Á§∫
        this.showUploadModal();
    }

    // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆöÁîªÈù¢„ÇíË°®Á§∫
    showUploadModal() {
        const modal = document.getElementById('upload-modal');
        const titleInput = document.getElementById('document-title');
        const formatSelect = document.getElementById('upload-format');
        
        // „Çø„Éñ„Çø„Ç§„Éà„É´„ÇíËá™ÂãïË®≠ÂÆö
        const currentTitle = this.getCurrentTabTitle();
        titleInput.value = currentTitle;
        
        // ÂâçÂõû„ÅÆË®≠ÂÆö„ÇíÂæ©ÂÖÉ
        const lastFormat = localStorage.getItem('google_docs_last_format');
        if (lastFormat) {
            formatSelect.value = lastFormat;
        }
        
        this.resetModalState();
        modal.style.display = 'block';
        titleInput.focus();
    }

    // ÁèæÂú®„ÅÆ„Çø„Éñ„Çø„Ç§„Éà„É´„ÇíÂèñÂæó
    getCurrentTabTitle() {
        if (window.getCurrentTabTitle) {
            return window.getCurrentTabTitle();
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´„Çí‰ΩøÁî®
        const pageTitle = document.title;
        if (pageTitle && pageTitle !== 'Markdown Editor') {
            return pageTitle;
        }
        
        return 'Êñ∞„Åó„ÅÑ„Éâ„Ç≠„É•„É°„É≥„Éà';
    }

    // „É¢„Éº„ÉÄ„É´„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
    resetModalState() {
        const errorDiv = document.getElementById('upload-error');
        const retrySection = document.getElementById('retry-section');
        const progressBar = document.getElementById('upload-progress');
        const executeBtn = document.getElementById('upload-execute-btn');
        
        errorDiv.style.display = 'none';
        retrySection.style.display = 'none';
        progressBar.style.display = 'none';
        executeBtn.disabled = false;
        executeBtn.textContent = 'üì§ „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ';
        
        this.retryCount = 0;
    }

    // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å
    async executeUpload(title, format) {
        const executeBtn = document.getElementById('upload-execute-btn');
        const progressBar = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');
        
        try {
            executeBtn.disabled = true;
            executeBtn.textContent = '‚è≥ „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...';
            progressBar.style.display = 'block';
            progressFill.style.width = '20%';
            
            // „Ç®„Éá„Ç£„Çø„ÅÆÂÜÖÂÆπ„ÇíÂèñÂæó
            const content = this.getEditorContent();
            if (!content.trim()) {
                throw new Error('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
            
            progressFill.style.width = '40%';
            
            // „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂ§âÊèõ
            const processedContent = await this.processContent(content, format);
            
            progressFill.style.width = '60%';
            
            // Google Docs„Éâ„Ç≠„É•„É°„É≥„Éà„Çí‰ΩúÊàê
            const documentUrl = await this.createGoogleDoc(title, processedContent, format);
            
            progressFill.style.width = '100%';
            
            // ÊàêÂäüÂá¶ÁêÜ
            this.handleUploadSuccess(title, documentUrl, format);
            
        } catch (error) {
            console.error('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
            this.handleUploadError(error);
        }
    }

    // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂá¶ÁêÜÔºà„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂ§âÊèõÔºâ
    async processContent(content, format) {
        if (format === 'html') {
            return this.convertMarkdownToHtml(content);
        }
        return content; // MarkdownÂΩ¢Âºè„ÅØ„Åù„ÅÆ„Åæ„Åæ
    }

    // Markdown „Çí HTML „Å´Â§âÊèõ
    convertMarkdownToHtml(markdown) {
        try {
            // Á∞°ÊòìÁöÑ„Å™Markdown‚ÜíHTMLÂ§âÊèõ
            let html = markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/`(.*)`/gim, '<code>$1</code>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>');
            
            html = '<p>' + html + '</p>';
            return html;
        } catch (error) {
            console.error('MarkdownÂ§âÊèõ„Ç®„É©„Éº:', error);
            throw new Error('Markdown‚ÜíHTMLÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
    }

    // Google Docs„Éâ„Ç≠„É•„É°„É≥„Éà„Çí‰ΩúÊàê
    async createGoogleDoc(title, content, format) {
        try {
            // „Éâ„Ç≠„É•„É°„É≥„Éà‰ΩúÊàê
            const createResponse = await fetch('https://docs.googleapis.com/v1/documents', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title
                })
            });

            if (!createResponse.ok) {
                const errorData = await createResponse.json();
                throw new Error(`„Éâ„Ç≠„É•„É°„É≥„Éà‰ΩúÊàê„Ç®„É©„Éº: ${errorData.error?.message || createResponse.status}`);
            }

            const docData = await createResponse.json();
            const documentId = docData.documentId;

            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊåøÂÖ•
            const insertResponse = await fetch(`https://docs.googleapis.com/v1/documents/${documentId}:batchUpdate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requests: [{
                        insertText: {
                            location: {
                                index: 1
                            },
                            text: content
                        }
                    }]
                })
            });

            if (!insertResponse.ok) {
                const errorData = await insertResponse.json();
                throw new Error(`„Ç≥„É≥„ÉÜ„É≥„ÉÑÊåøÂÖ•„Ç®„É©„Éº: ${errorData.error?.message || insertResponse.status}`);
            }

            // „Éâ„Ç≠„É•„É°„É≥„ÉàURL„ÇíËøî„Åô
            return `https://docs.google.com/document/d/${documentId}/edit`;

        } catch (error) {
            console.error('Google Docs‰ΩúÊàê„Ç®„É©„Éº:', error);
            
            if (error.message.includes('401')) {
                this.clearAuthState();
                throw new Error('Ë™çË®º„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            throw error;
        }
    }

    // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäüÂá¶ÁêÜ
    handleUploadSuccess(title, documentUrl, format) {
        const modal = document.getElementById('upload-modal');
        
        // Ë®≠ÂÆö„Çí‰øùÂ≠ò
        localStorage.setItem('google_docs_last_format', format);
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        modal.style.display = 'none';
        
        // ÊàêÂäüÈÄöÁü•
        const message = `„Äå${title}„Äç„ÇíGoogle Docs„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ\n\n„Éâ„Ç≠„É•„É°„É≥„Éà„ÇíÈñã„Åç„Åæ„Åô„ÅãÔºü`;
        if (confirm(message)) {
            window.open(documentUrl, '_blank');
        }
        
        this.resetModalState();
    }

    // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„ÉºÂá¶ÁêÜ
    handleUploadError(error) {
        const executeBtn = document.getElementById('upload-execute-btn');
        const progressBar = document.getElementById('upload-progress');
        
        executeBtn.disabled = false;
        executeBtn.textContent = 'üì§ „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ';
        progressBar.style.display = 'none';
        
        // „Ç®„É©„ÉºÂàÜÈ°û„Å®„É°„ÉÉ„Çª„Éº„Ç∏
        let errorMessage = error.message || '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        let showRetry = true;
        
        if (error.message.includes('Ë™çË®º')) {
            errorMessage = 'Ë™çË®º„Ç®„É©„Éº: ' + error.message;
            showRetry = false;
        } else if (error.message.includes('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ')) {
            errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: ' + error.message;
        } else if (error.message.includes('API')) {
            errorMessage = 'Google API„Ç®„É©„Éº: ' + error.message;
        }
        
        this.showError(errorMessage, showRetry);
    }

    // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
    showError(message, showRetry = true) {
        const errorDiv = document.getElementById('upload-error');
        const retrySection = document.getElementById('retry-section');
        
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        if (showRetry && this.retryCount < this.maxRetries) {
            retrySection.style.display = 'block';
        } else {
            retrySection.style.display = 'none';
        }
    }

    // „Ç®„Éá„Ç£„Çø„ÅÆÂÜÖÂÆπ„ÇíÂèñÂæó
    getEditorContent() {
        if (window.getMarkdownContent) {
            return window.getMarkdownContent();
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const editor = document.getElementById('editor');
        return editor ? editor.value || '' : '';
    }

    // Google OAuthË™çË®º„ÇíÈñãÂßã
    async startAuthentication() {
        try {
            console.log('Google OAuthË™çË®º„ÇíÈñãÂßã„Åó„Åæ„Åô...');
            
            // Ë™çË®º„Çµ„Éº„Éê„Éº„ÅÆ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
            const healthResponse = await fetch(`${this.authServerUrl}/health`);
            if (!healthResponse.ok) {
                throw new Error('Ë™çË®º„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            // OAuthË™çË®ºURL„ÇíÂèñÂæó
            const authResponse = await fetch(`${this.authServerUrl}/auth/google`);
            if (!authResponse.ok) {
                throw new Error('Ë™çË®ºURL„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
            
            const authData = await authResponse.json();
            
            // Êñ∞„Åó„ÅÑ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßË™çË®º„Éö„Éº„Ç∏„ÇíÈñã„Åè
            const authWindow = window.open(
                authData.authUrl,
                'googleAuth',
                'width=500,height=600,scrollbars=yes,resizable=yes'
            );
            
            // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
            this.waitForAuthCompletion(authWindow);
            
        } catch (error) {
            console.error('Ë™çË®ºÈñãÂßã„Ç®„É©„Éº:', error);
            alert(`Ë™çË®º„Ç®„É©„Éº: ${error.message}`);
        }
    }

    // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
    waitForAuthCompletion(authWindow) {
        const checkClosed = setInterval(() => {
            if (authWindow.closed) {
                clearInterval(checkClosed);
                // Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
                setTimeout(() => {
                    this.checkAuthenticationResult();
                }, 1000);
            }
        }, 1000);
        
        // 5ÂàÜÂæå„Å´„Çø„Ç§„É†„Ç¢„Ç¶„Éà
        setTimeout(() => {
            if (!authWindow.closed) {
                authWindow.close();
                clearInterval(checkClosed);
                alert('Ë™çË®º„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }, 5 * 60 * 1000);
    }

    // Ë™çË®ºÁµêÊûú„ÇíÁ¢∫Ë™ç
    async checkAuthenticationResult() {
        try {
            const response = await fetch(`${this.authServerUrl}/auth/status`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const authData = await response.json();
                if (authData.authenticated) {
                    // Ë™çË®ºÊàêÂäü
                    this.accessToken = authData.accessToken;
                    this.userInfo = authData.userInfo;
                    this.isAuthenticated = true;
                    
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºàÊúâÂäπÊúüÈôê‰ªò„ÅçÔºâ
                    const expiresAt = Date.now() + (24 * 60 * 60 * 1000); // 24ÊôÇÈñìÂæå
                    localStorage.setItem('google_auth_data', JSON.stringify({
                        accessToken: this.accessToken,
                        userInfo: this.userInfo,
                        timestamp: Date.now(),
                        expiresAt: expiresAt
                    }));
                    
                    this.updateButtonState();
                    alert(`GoogleË™çË®º„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Åì„Çì„Å´„Å°„ÅØ„ÄÅ${this.userInfo.name}„Åï„ÇìÔºÅ`);
                    
                    // Ë™çË®ºÂÆå‰∫ÜÂæå„ÄÅ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÁîªÈù¢„ÇíË°®Á§∫
                    setTimeout(() => {
                        this.showUploadModal();
                    }, 500);
                } else {
                    throw new Error('Ë™çË®º„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } else {
                throw new Error('Ë™çË®ºÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        } catch (error) {
            console.error('Ë™çË®ºÁµêÊûúÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
            alert('Ë™çË®º„ÅÆÂÆå‰∫ÜÁ¢∫Ë™ç„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
        }
    }

    // Ë™çË®ºÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
    clearAuthState() {
        this.isAuthenticated = false;
        this.accessToken = null;
        this.userInfo = null;
        localStorage.removeItem('google_auth_data');
        this.updateButtonState();
    }

    // „É≠„Ç∞„Ç¢„Ç¶„Éà
    logout() {
        this.clearAuthState();
        alert('Google Docs„Åã„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
    }
}

// ES6„É¢„Ç∏„É•„Éº„É´„Å®„Åó„Å¶„Ç®„ÇØ„Çπ„Éù„Éº„Éà
export default GoogleDocsUploader;
